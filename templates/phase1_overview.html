<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phase 1 Overview Flowchart</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
    }
    #mermaidChart {
      padding: 20px;
      background-color: #fff;
      overflow-x: auto;
    }
    .mermaid {
      font-size: 16px;
    }
    svg {
      max-width: 100% !important;
      height: auto !important;
    }
  </style>
</head>
<body>
  <div id="mermaidChart">
    <pre class="mermaid">
{% raw %}
flowchart TD
    Start(["Start: New Enquiry<br>(Phone, Email, GP Referral, Webform, Callback, WhatsApp)"]) --> Source{"What is the source?"}

    Source -- Phone Call --> M1["Send: Phone call received (No SC No GP Referral)<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    Source -- Voicemail --> M2["Send: Missed Call (Voicemail)<br><sub>ğŸ“ Email</sub>"]
    Source -- No Voicemail --> M3["Send: Missed Call (No Voicemail)<br><sub>ğŸ“ Email</sub>"]
    Source -- Callback --> M4["Send: Callback Request<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    Source -- Email --> M5["Send: Email Request (Attach Parent Info)<br><sub>ğŸ“ Email</sub>"]
    Source -- GP Referral --> M6["Send: GP Referral Received (No Screening Call done)<br><sub>ğŸ“ Email</sub>"]
    Source -- Webform --> CheckDup{"Is it an existing record?"}

    M1 --> CheckDup
    M2 --> CheckDup
    M3 --> CheckDup
    M4 --> CheckDup
    M5 --> CheckDup
    M6 --> CheckDup

    CheckDup -- Yes --> LoadRec["Load Patient Record"]
    LoadRec --> ConsentCheck["Check: WhatsApp Consent Exists"]

    CheckDup -- No --> CreateRec["Create Patient Record"]
    CreateRec --> ConsentCheck
    ConsentCheck -- No --> M0["Send: WA Consent Request<br><sub>ğŸ“ Email</sub>"]
    ConsentCheck --> GPCheck{"Is GP Referral Received?"}

    GPCheck -- Yes --> M19["Send: GP Referral Received, Havenâ€™t booked SC<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    M19 --> SCBookedNow{"Is Screening Call Already Booked?"}
    GPCheck -- No --> SCBookedNow

    SCBookedNow -- Yes --> M9["Send: Screening Call Booked<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    SCBookedNow -- No --> WaitMore["WaitMore"]

    WaitMore -- 7 Days No Response --> M7["Send: No contact 7-days - Follow up<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    M7 -- 7 More Days No Response --> M8["Send: No contact 14-days - Follow up<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    M8 -- No Response --> Close1["Sad End: Auto-Close â€“ No Booking"]
    M8 -- SC Booked --> M9

    M9 --> ChildCheck["Two Children's Names Provided?"]
    ChildCheck -- Yes --> M20["Send: Screening Call Slot Booked - Two Childrenâ€™s Names Provided<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    M20 --> SCBookedNow
    M20 --> APAssign["Assign to AP Calendar Queue"]
    ChildCheck -- No --> APAssign

    APAssign --> APExec["AP Executes Screening Call (Phone)"]
    APExec --> CheckSchoolFields{"Are School Name, Email, or Teacher Name missing in CRM?"}
    CheckSchoolFields -- Yes --> MFollowSchool["Send: Follow-up School Details after SC execution by AP<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    CheckSchoolFields -- No --> GPCheck2{"Is GP Referral Received?"}
    MFollowSchool --> GPCheck2

    GPCheck2 -- No --> M21a["Send: Screening Call Completed, No GP Referral Yet<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    M21a --> FlagCheck{"Red Flags Identified?"}
    GPCheck2 -- Yes --> InfoCheck{"Any missing documents?"}

    FlagCheck -- Yes --> RedList["Red Flag Types:<br>â€¢ CAMHS<br>â€¢ Eating Disorder<br>â€¢ Non-Verbal Child<br>â€¢ Suicide Attempts<br>â€¢ Can't Attend In-Person<br>â€¢ AP Clinical Concern"]
    RedList --> EscalateFlag["Flag to CC: Manual Review Required"]
    EscalateFlag --> CloseRedFlag["Sad End: Red Flag â€“ Do Not Proceed"]

    FlagCheck -- No --> InfoCheck

    InfoCheck -- Yes --> M22a["Send: Screening Call Completed, GP Referral Received, No Previous Report(s) Yet<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    M22a --> DocWait["Wait for Docs"]
    DocWait -- 14 Days --> DocReceived{"Docs Received?"}
    DocReceived -- No --> EscalateMissing["Flag to CC: Missing Docs (Manual Escalation)"]
    EscalateMissing --> Close2["Sad End: Auto-Close â€“ Missing Docs"]
    DocReceived -- Yes --> G2Check{"Is G2 Consent Required?"}

    InfoCheck -- No --> G2Check
    G2Check -- Yes --> M12["Send: G2 Consent Required (Screening Call done &amp; GP Referral Received)<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    M12 --> M13["Send: Follow-up WA re. G2 consent for assessment<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    M13 --> M14["Send: G2 Consent Received (Screening Call done)<br><sub>ğŸ“ WA if consented, else Email</sub>"]

    G2Check -- No --> CMReview["Care Manager Review"]
    M14 --> CMReview

    CMReview --> Decision{"Care Manager Decision"}
    Decision -- Accepted --> M17["Send: GP Referral Received (Screening Call done)<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    M17 --> FinalPrep["Assessment Ready"]
    FinalPrep --> M18["Send: Secondary Assessment Notification<br><sub>ğŸ“ WA if consented, else Email</sub>"]
    M18 --> HappyEnd["Happy End: Proceed to Assessment"]

    Decision -- Rejected --> RejectNotify["Notify GP + G1 (Manual)"]
    RejectNotify --> Close3["Sad End: Rejected"]
    Decision -- On Hold --> HoldStatus["Status: Awaiting Additional Info"]

    %% Styling
    class M0,M1,M2,M3,M4,M5,M6,M7,M8,M9,M12,M13,M14,M17,M18,M19,M20,M21a,M22a,MFollowSchool message
    class Close1,Close2,Close3,CloseRedFlag sadend
    classDef message fill:#fff8dc,stroke:#b8860b,stroke-width:1px
    classDef sadend fill:#ffe6e6,stroke:#cc0000,stroke-width:1px
    classDef fieldcheck fill:#e6f7ff,stroke:#1890ff,stroke-width:1px
{% endraw %}
    </pre>
  </div>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        padding: 10
      }
    });
  </script>
</body>
</html>
