<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PrimaHealth Phase 1 Workflow</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 40px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 20px;
    }
    #mermaidChart {
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }
    .mermaid {
      font-size: 16px;
    }
    svg {
      max-width: 100% !important;
      height: auto !important;
    }
  </style>
</head>
<body>
  <h1>Phase 1: Patient Intake and Screening Workflow</h1>
  <div id="mermaidChart">
    <pre class="mermaid">
{% raw %}
flowchart TD
    Start(["Start: New Enquiry<br>(Phone, Email, GP Referral, Webform, WhatsApp)"]) --> Source{"What is the source?"}

    Source -- Phone Call --> M1["Send: Phone call received (No SC No GP Referral)<br><sub>📝 Email</sub>"]
    Source -- Voicemail --> M2["Send: Missed Call (Voicemail)<br><sub>📝 Email</sub>"]
    Source -- No Voicemail --> M3["Send: Missed Call (No Voicemail)<br><sub>📝 Email</sub>"]
    Source -- Webform --> M4["Send: Callback Request<br><sub>📝 Email</sub>"]
    Source -- Email --> M5["Send: Email Request (Attach Parent Info)<br><sub>📝 Email</sub>"]
    Source -- GP Referral --> M6["Send: GP Referral Received (No Screening Call done)<br><sub>📝 Email</sub>"]

    M1 --> ExistingCheck{"Is it an existing record?"}
    M2 --> ExistingCheck
    M3 --> ExistingCheck
    M4 --> ExistingCheck
    M5 --> ExistingCheck
    M6 --> ExistingCheck

    ExistingCheck -- Yes --> LoadRec["Load Patient Record"]
    LoadRec --> M0
    ExistingCheck -- No --> CreateRec["Create Patient Record"]
    CreateRec --> M0

    M0["Send: WA Consent Request via Email<br><sub>📝 Email</sub>"] --> Wait24H["⏳ Wait 24 Hours for Email Response"]
    Wait24H --> ConsentResponse{"Email Response Received?"}
    ConsentResponse -- Yes, WA Consent Given --> CRMUpdateYes["✅ Update CRM: Consent Given – Proceed via WA"]
    ConsentResponse -- No or Declined --> CRMUpdateNo["❌ Update CRM: Consent Not Given – Proceed via Email Only"]

    CRMUpdateYes --> GPCheck{"Is GP Referral Received?"}
    CRMUpdateNo --> GPCheck

    GPCheck -- Yes --> M19["Send: GP Referral Received, Haven’t booked SC<br><sub>📝 WA if consented, else Email</sub>"]
    M19 --> SCBookedNow{"Is Screening Call Already Booked?"}
    GPCheck -- No --> SCBookedNow

    SCBookedNow -- Yes --> M9["Send: Screening Call Booked<br><sub>📝 WA if consented, else Email</sub>"]
    SCBookedNow -- No --> WaitMore["WaitMore"]

    WaitMore -- 7 Days No Response --> M7["Send: No contact 7-days - Follow up<br><sub>📝 WA if consented, else Email</sub>"]
    M7 --> CallAttempt["📞 Flag CC to make a Phone Call Attempt after 7 days"]
    CallAttempt --> CallAnswered{"Was the call answered?"}

    CallAnswered -- Yes, Wants to proceed --> BookNowCheck{"Did they book Screening Call immediately?"}
    BookNowCheck -- Yes --> M9
    BookNowCheck -- No --> FollowUp14Days

    CallAnswered -- Yes, Does NOT want to proceed --> SadEndCall["Sad End: Declined to Proceed<br><sub>📝 WA if consented, else Email</sub>"]
    CallAnswered -- Yes, Will book later --> RemindWA["Send: Reminder – To Book SC<br><sub>📝 WA if consented, else Email</sub>"]
    RemindWA --> FollowUp14Days
    CallAnswered -- No --> NoAnswerFollowup["Send: No Answer – Follow-up<br><sub>📝 WA if consented, else Email</sub>"]
    NoAnswerFollowup --> FollowUp14Days

    FollowUp14Days["Send: No contact 14-days - Follow up<br><sub>📝 WA if consented, else Email</sub>"]
    FollowUp14Days -- 7 More Days No Response --> Close1["Sad End: Auto-Close – No Booking"]
    FollowUp14Days -- SC Booked --> M9

    M9 --> ChildCheck{"Two Children's Names Provided?"}
    ChildCheck -- Yes --> M20["Send: Screening Call Slot Booked - Two Children’s Names Provided<br><sub>📝 WA if consented, else Email</sub>"]
    M20 --> APAssign["Assign to AP Calendar Queue"]
    ChildCheck -- No --> APAssign

    APAssign --> APExec["AP Executes Screening Call (Phone)"]
    APExec --> CheckSchoolFields{"Are School Name, Email, or Teacher Name missing in CRM?"}
    CheckSchoolFields -- Yes --> MFollowSchool["Send: Follow-up School Details after SC execution by AP<br><sub>📝 WA if consented, else Email</sub>"]
    MFollowSchool --> GPCheck2{"Is GP Referral Received?"}
    CheckSchoolFields -- No --> GPCheck2

    GPCheck2 -- No --> M21a["Send: Screening Call Completed, No GP Referral Yet<br><sub>📝 WA if consented, else Email</sub>"]
    M21a --> FlagCheck{"Red Flags Identified?"}
    GPCheck2 -- Yes --> InfoCheck{"Any missing documents?"}

    FlagCheck -- Yes --> RedList["Red Flag Types:<br>• CAMHS<br>• Eating Disorder<br>• Non-Verbal Child<br>• Suicide Attempts<br>• Can't Attend In-Person<br>• AP Clinical Concern"]
    RedList --> EscalateFlag["Flag to CC: Manual Review Required"]
    EscalateFlag --> CloseRedFlag["Sad End: Red Flag – Do Not Proceed"]
    FlagCheck -- No --> InfoCheck

    InfoCheck -- Yes --> M22a["Send: Screening Call Completed, GP Referral Received, No Previous Report(s) Yet<br><sub>📝 WA if consented, else Email</sub>"]
    M22a --> DocWait["Wait for Docs"]
    DocWait -- 14 Days --> DocReceived{"Docs Received?"}
    DocReceived -- No --> EscalateMissing["Flag to CC: Missing Docs (Manual Escalation)"]
    EscalateMissing --> Close2["Sad End: Close – Incomplete Case – Missing Documents"]
    DocReceived -- Yes --> G2Check{"Is G2 Consent Required?"}

    InfoCheck -- No --> G2Check
    G2Check -- Yes --> M12["Send: G2 Consent Required<br><sub>📝 WA if consented, else Email</sub>"]
    M12 --> Wait7DaysG2["⏳ Wait 7 Days Before Follow-up"]
    Wait7DaysG2 --> M13["Send: Follow-up WA re. G2 consent<br><sub>📝 WA if consented, else Email</sub>"]
    M13 --> M14["Send: G2 Consent Received<br><sub>📝 WA if consented, else Email</sub>"]

    G2Check -- No --> CMReview["Care Manager Review"]
    M14 --> CMReview

    CMReview --> Decision{"Care Manager Decision"}
    Decision -- Accepted --> M17["Send: GP Referral Received (SC done)<br><sub>📝 WA if consented, else Email</sub>"]
    M17 --> FinalPrep["Assessment Ready"]
    FinalPrep --> M18["Send: Secondary Assessment Notification<br><sub>📝 WA if consented, else Email</sub>"]
    M18 --> HappyEnd["Happy End: Proceed to Assessment"]

    Decision -- Rejected --> RejectNotify["Notify GP + G1 (Manual)"]
    RejectNotify --> Close3["Sad End: Rejected"]
    Decision -- On Hold --> HoldStatus["Status: Awaiting Additional Info"]

    %% Styling
    class M0,M1,M2,M3,M4,M5,M6,M7,M9,M12,M13,M14,M17,M18,M19,M20,M21a,M22a,MFollowSchool,RemindWA,NoAnswerFollowup,CallAttempt,FollowUp14Days message
    class Close1,Close2,Close3,CloseRedFlag,SadEndCall sadend
    class CRMUpdateYes,CRMUpdateNo,Wait24H,ConsentResponse,Wait7DaysG2 logic
    classDef message fill:#fef6e4,stroke:#c4a000,stroke-width:1px
    classDef sadend fill:#ffe6e6,stroke:#cc0000,stroke-width:1px
    classDef logic fill:#e0f7fa,stroke:#00796b,stroke-width:1px

{% endraw %}
    </pre>
  </div>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        padding: 10,
        curve: 'basis'
      }
    });
  </script>
</body>
</html>
